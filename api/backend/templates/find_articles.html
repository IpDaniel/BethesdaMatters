<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Articles - Bethesda Matters</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}">
    <style>
        .search-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .search-bar {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-bottom: 2rem;
        }

        .articles-list {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .article-card {
            display: flex;
            margin-bottom: 2rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .article-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .article-image {
            width: 250px;
            height: 200px;
            object-fit: cover;
        }

        .article-info {
            padding: 1rem;
            flex: 1;
        }

        .article-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin: 0 0 0.5rem 0;
            color: #000;
        }

        .article-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .article-meta span:not(:last-child)::after {
            content: '|';
            margin: 0 0.5rem;
            color: #ddd;
        }

        .article-description {
            color: #444;
            line-height: 1.5;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .filter-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }
    </style>
    <script>
        let isLoading = false;
        let page = 1;
        
        function createArticleCard(article) {
            return `
                <article class="article-card">
                    <img src="${article.cover_image}" alt="Article image" class="article-image">
                    <div class="article-info">
                        <h2 class="article-title">${article.title}</h2>
                        <div class="article-meta">
                            <span>By ${article.authors.map(a => a.name).join(', ')}</span>
                            <span>${article.published_date}</span>
                            <span>${article.read_time}</span>
                        </div>
                        <p class="article-description">${article.summary}</p>
                    </div>
                </article>
            `;
        }

        function loadMoreArticles() {
            if (isLoading) return;
            
            isLoading = true;
            const searchText = document.querySelector('.search-bar').value;
            const selectedGenres = Array.from(document.querySelector('#genre-select').selectedOptions).map(opt => opt.value);
            const selectedAuthors = Array.from(document.querySelector('#author-select').selectedOptions).map(opt => parseInt(opt.value));
            
            const package = {
                constraints: {
                    genre_matches: selectedGenres.length > 0 ? selectedGenres : null,
                    author_id_matches: selectedAuthors.length > 0 ? selectedAuthors : null,
                    text_contains: searchText ? searchText.split(' ').filter(word => word.length > 0) : null
                },
                prior_priority_score: 10,
                number_requested: 3,
                page: page
            };

            fetch('/articles/metadata/search-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(package)
            })
            .then(response => response.json())
            .then(data => {
                const articlesList = document.querySelector('.articles-list');
                data.articles.forEach(article => {
                    articlesList.insertAdjacentHTML('beforeend', createArticleCard(article));
                });
                page++;
                isLoading = false;
            })
            .catch(error => {
                console.error('Error:', error);
                isLoading = false;
            });
        }

        // Detect when user scrolls near bottom
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
                loadMoreArticles();
            }
        });

        // Debounce helper function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Add this function to load initial articles
        function loadInitialArticles() {
            document.querySelector('.articles-list').innerHTML = '<div>Loading...</div>';
            
            const package = {
                constraints: {
                    genre_matches: [],
                    author_id_matches: [],
                    text_contains: []
                },
                prior_priority_score: 10,
                number_requested: 10,
                page: 1
            };

            // Convert to URL parameters properly
            const params = new URLSearchParams();
            params.append('package', JSON.stringify(package));

            fetch(`/articles/metadata/search-order?${params.toString()}`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                const articlesList = document.querySelector('.articles-list');
                articlesList.innerHTML = '';
                data.articles.forEach(article => {
                    articlesList.insertAdjacentHTML('beforeend', createArticleCard(article));
                });
                page++;
            })
            .catch(() => {
                document.querySelector('.articles-list').innerHTML = '<div>Error loading articles</div>';
            });
        }

        // Modify the DOMContentLoaded event listener to ensure it's properly placed
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize the page number
            page = 1;
            // Load initial articles
            loadInitialArticles();
            
            // Set up event listeners for filters
            document.querySelector('.search-bar').addEventListener('input', debounce(() => {
                page = 1;
                document.querySelector('.articles-list').innerHTML = '';
                loadMoreArticles();
            }, 300));

            document.querySelector('#genre-select').addEventListener('change', () => {
                page = 1;
                document.querySelector('.articles-list').innerHTML = '';
                loadMoreArticles();
            });

            document.querySelector('#author-select').addEventListener('change', () => {
                page = 1;
                document.querySelector('.articles-list').innerHTML = '';
                loadMoreArticles();
            });
        });
    </script>
</head>
<body>
    <header>
        <h1 class="masthead">Bethesda Matters</h1>
        <p>Your Trusted Source for Local News</p>
    </header>

    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="#">Local News</a></li>
            <li><a href="#">Politics</a></li>
            <li><a href="#">Business</a></li>
            <li><a href="#">Sports</a></li>
            <li><a href="#">Culture</a></li>
            <li><a href="#">Opinion</a></li>
        </ul>
    </nav>

    <div class="search-container">
        <input type="text" class="search-bar" placeholder="Search articles...">
        <div class="filter-controls">
            <select multiple id="genre-select" class="filter-select">
                <option value="Business">Business</option>
                <option value="Sports">Sports</option>
                <option value="Politics">Politics</option>
                <option value="Culture">Culture</option>
                <option value="Opinion">Opinion</option>
            </select>
            <select multiple id="author-select" class="filter-select">
                <!-- This should be populated dynamically from your backend -->
            </select>
        </div>
    </div>

    <div class="articles-list">
        <!-- Remove static article examples -->
    </div>

    <div id="loading" style="text-align: center; padding: 2rem; display: none;">
        Loading more articles...
    </div>

    <!-- Include your existing footer here -->
</body>
</html>
